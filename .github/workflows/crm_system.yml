name: CRM Backend (Combo Action)

on:
  workflow_dispatch:
  repository_dispatch:

jobs:
  crm-core:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          persist-credentials: false

      - name: Executar L√≥gica
        env:
          MY_TOKEN: ${{ secrets.GH_PAT }} 
          PAYLOAD_JSON: ${{ toJson(github.event.client_payload) }}
          API_KEY: ${{ secrets.BOTCONVERSA_KEY }}
        run: |
          git config --global user.name 'CRM Robot'
          git config --global user.email 'bot@warrior.com'
          git remote set-url origin https://x-access-token:${MY_TOKEN}@github.com/${{ github.repository }}
          git pull origin main || echo "J√° atualizado"

          node -e "
            const fs = require('fs');
            let payload = {};
            try {
                const raw = process.env.PAYLOAD_JSON;
                if(raw && raw !== 'null') payload = JSON.parse(raw);
            } catch (e) {}

            const action = payload.real_action || 'unknown';
            console.log('--- COMANDO: ' + action + ' ---');

            const defaultColumns = {
              'todo': { title: 'üì• Novos', color: '#ff5630', days: 0 },
              'doing': { title: 'üî® Em Produ√ß√£o', color: '#ffab00', days: 30 },
              'done': { title: '‚úÖ Finalizado', color: '#42526e', days: 0 }
            };
            const defaultOrder = ['todo', 'doing', 'done'];

            let db = { columns: defaultColumns, columnOrder: defaultOrder, orders: [] };
            
            if (fs.existsSync('db.json')) {
                try {
                  const content = fs.readFileSync('db.json', 'utf8');
                  if (content.trim()) {
                    const json = JSON.parse(content);
                    if (Array.isArray(json)) db.orders = json;
                    else { 
                         db.orders = json.orders || [];
                         db.columns = json.columns || defaultColumns;
                         db.columnOrder = json.columnOrder || Object.keys(db.columns);
                    }
                  }
                } catch (err) {}
            }

            // --- ROTEADOR ---

            if (action === 'save_columns') {
                if (payload.columns) db.columns = payload.columns;
                if (payload.order) db.columnOrder = payload.order;
            }
            
            else if (action === 'novo_pedido') {
                const now = Date.now();
                const novo = {
                  id: payload.id || ('ped-' + now),
                  client: payload.nome || 'Cliente',
                  phone: payload.telefone || '',
                  chat_id: payload.chat_id || '',
                  product: payload.produto || 'Pedido',
                  dueDate: payload.prazo || '',
                  status: payload.status || 'todo',
                  waiting: payload.waiting !== undefined ? payload.waiting : false, // ACEITA STATUS INICIAL
                  createdAt: now,
                  finishedAt: null,
                  history: []
                };
                db.orders.push(novo);
            }

            else if (action === 'update_status') {
                const index = db.orders.findIndex(o => o.id === payload.id);
                if (index > -1) {
                  const oldStatus = db.orders[index].status;
                  const newStatus = payload.status;
                  if (!db.orders[index].history) db.orders[index].history = [];
                  db.orders[index].history.push({ from: oldStatus, to: newStatus, date: Date.now() });
                  if (newStatus === 'done') db.orders[index].finishedAt = Date.now();
                  if (oldStatus === 'done' && newStatus !== 'done') db.orders[index].finishedAt = null;
                  db.orders[index].status = newStatus;
                  if (payload.newDate) db.orders[index].dueDate = payload.newDate;
                }
            }

            else if (action === 'update_order') {
                const index = db.orders.findIndex(o => o.id === payload.id);
                if (index > -1) {
                    if (payload.client) db.orders[index].client = payload.client;
                    if (payload.phone !== undefined) db.orders[index].phone = payload.phone;
                    if (payload.product) db.orders[index].product = payload.product;
                    if (payload.dueDate) db.orders[index].dueDate = payload.dueDate;
                }
            }

            else if (action === 'delete_order') {
                const targetId = payload.id;
                const targetChatId = payload.chat_id;
                db.orders = db.orders.filter(o => {
                    if (targetId && o.id === targetId) return false;
                    if (targetChatId && o.chat_id == targetChatId) return false;
                    return true;
                });
            }
            
            else if (action === 'toggle_waiting') {
                const index = db.orders.findIndex(o => o.chat_id === payload.chat_id || o.id === payload.id);
                if (index > -1) {
                    db.orders[index].waiting = payload.waiting;
                }
            }
            
            else if (action === 'move_card_external') {
                 const newStatus = payload.status;
                 const index = db.orders.findIndex(o => o.chat_id === payload.chat_id);
                 let newDate = '';
                 const colConfig = (db.columns && db.columns[newStatus]) ? db.columns[newStatus] : { days: 0 };
                 if (colConfig.days > 0) {
                    const d = new Date(); d.setDate(d.getDate() + colConfig.days);
                    newDate = d.toISOString().split('T')[0];
                 }
                 
                 if (index > -1) {
                    if (!db.orders[index].history) db.orders[index].history = [];
                    db.orders[index].history.push({ from: db.orders[index].status, to: newStatus, date: Date.now() });
                    if (newStatus === 'done') db.orders[index].finishedAt = Date.now();
                    
                    db.orders[index].status = newStatus;
                    if (newDate) db.orders[index].dueDate = newDate;
                    if (payload.telefone) db.orders[index].phone = payload.telefone;
                    
                    // --- COMBO: ATUALIZA O SEM√ÅFORO JUNTO ---
                    if (payload.waiting !== undefined) db.orders[index].waiting = payload.waiting;
                 } else {
                    const now = Date.now();
                    const novo = {
                      id: 'ped-' + now,
                      client: payload.nome || 'Cliente Bot',
                      phone: payload.telefone || '',
                      chat_id: payload.chat_id || '',
                      product: 'Pedido via Bot',
                      dueDate: newDate || '',
                      status: newStatus,
                      waiting: payload.waiting !== undefined ? payload.waiting : false, // STATUS INICIAL
                      createdAt: now,
                      history: []
                    };
                    db.orders.push(novo);
                 }
            }

            fs.writeFileSync('db.json', JSON.stringify(db, null, 2));
          "

          git add db.json
          git commit -m "CRM Action: ${{ github.event.action }}" || echo "Nada mudou"
          git push origin main || (git pull --rebase origin main && git push origin main)
