name: CRM Backend (Final)

on:
  repository_dispatch:
    types: [novo_pedido, update_status, delete_order, save_columns, update_order, move_card_external]

jobs:
  gerenciar-crm:
    runs-on: ubuntu-latest
    steps:
      - name: Baixar c√≥digo
        uses: actions/checkout@v3
        with:
          persist-credentials: false

      - name: Processar e Salvar
        env:
          MY_TOKEN: ${{ secrets.GH_PAT }} 
          PAYLOAD_JSON: ${{ toJson(github.event.client_payload) }}
          ACTION_TYPE: ${{ github.event.action }}
          API_KEY: ${{ secrets.BOTCONVERSA_KEY }}
        run: |
          git config --global user.name 'CRM Robot'
          git config --global user.email 'bot@warrior.com'
          
          # Previne conflito de atualiza√ß√µes
          git remote set-url origin https://x-access-token:${MY_TOKEN}@github.com/${{ github.repository }}
          git pull origin main || echo "J√° atualizado"

          node -e "
            const fs = require('fs');
            const action = process.env.ACTION_TYPE;
            const payload = JSON.parse(process.env.PAYLOAD_JSON);
            
            // Colunas Padr√£o
            const defaultColumns = {
              'todo': { title: 'üì• Novos', color: '#ff5630', days: 0 },
              'doing': { title: 'üî® Em Produ√ß√£o', color: '#ffab00', days: 30 },
              'done': { title: '‚úÖ Finalizado', color: '#42526e', days: 0 }
            };

            try {
              let db = { columns: defaultColumns, orders: [] };
              
              if (fs.existsSync('db.json')) {
                try {
                  const content = fs.readFileSync('db.json', 'utf8');
                  if (content.trim()) {
                    const json = JSON.parse(content);
                    if (Array.isArray(json)) { db.orders = json; } 
                    else { db = json; }
                  }
                } catch (err) { console.log('Criando novo DB...'); }
              }

              let notify = '';

              if (action === 'save_columns') {
                db.columns = payload;
              }
              else if (action === 'novo_pedido') {
                const novo = {
                  id: 'ped-' + Date.now(),
                  client: payload.nome || 'Cliente',
                  chat_id: payload.chat_id || '',
                  product: payload.produto || 'Pedido',
                  dueDate: payload.prazo || '',
                  status: 'todo'
                };
                db.orders.push(novo);
              }
              else if (action === 'update_status') {
                const index = db.orders.findIndex(o => o.id === payload.id);
                if (index > -1) {
                  db.orders[index].status = payload.status;
                  if (payload.newDate) db.orders[index].dueDate = payload.newDate;
                  notify = (db.orders[index].chat_id || '') + '|' + payload.status;
                }
              }
              else if (action === 'update_order') {
                const index = db.orders.findIndex(o => o.id === payload.id);
                if (index > -1) {
                    if (payload.client) db.orders[index].client = payload.client;
                    if (payload.product) db.orders[index].product = payload.product;
                    if (payload.dueDate) db.orders[index].dueDate = payload.dueDate;
                }
              }
              else if (action === 'delete_order') {
                db.orders = db.orders.filter(o => o.id !== payload.id);
              }
              
              // >>> AQUI EST√Å A INTEGRA√á√ÉO COM BOTCONVERSA <<<
              else if (action === 'move_card_external') {
                 // Procura pelo chat_id
                 const index = db.orders.findIndex(o => o.chat_id === payload.chat_id);
                 
                 if (index > -1) {
                    const newStatus = payload.status;
                    db.orders[index].status = newStatus;
                    
                    // Atualiza prazo se necess√°rio
                    const colConfig = db.columns[newStatus];
                    if (colConfig && colConfig.days > 0) {
                        const d = new Date(); d.setDate(d.getDate() + colConfig.days);
                        db.orders[index].dueDate = d.toISOString().split('T')[0];
                    }
                 } else {
                    console.log('Cliente n√£o encontrado para ID: ' + payload.chat_id);
                 }
              }

              fs.writeFileSync('db.json', JSON.stringify(db, null, 2));
              fs.writeFileSync('notify.txt', notify);

            } catch (e) {
              console.error('Erro Fatal:', e);
              process.exit(1); 
            }
          "

          git add db.json
          git commit -m "CRM: ${{ github.event.action }}" || echo "Nada mudou"
          git push origin main || (git pull --rebase origin main && git push origin main)

      - name: Notificar BotConversa
        env:
          API_KEY: ${{ secrets.BOTCONVERSA_KEY }}
        run: |
          if [ -f notify.txt ]; then
            CONTENT=$(cat notify.txt)
            if [ ! -z "$CONTENT" ]; then
              CHAT_ID=$(echo "$CONTENT" | cut -d'|' -f1)
              STATUS=$(echo "$CONTENT" | cut -d'|' -f2)
              if [ "${{ github.event.action }}" != "move_card_external" ]; then
                  if [ ! -z "$CHAT_ID" ] && [ "$STATUS" == "doing" ]; then
                     curl -s -X POST "https://backend.botconversa.com.br/api/v1/subscriber/$CHAT_ID/tags" \
                     -H "api-key: $API_KEY" \
                     -H "Content-Type: application/json" \
                     -d '{"tag_id": "Status: Produ√ß√£o"}'
                  fi
              fi
            fi
          fi
