<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CRM Warrior</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root { --bg: #f4f5f7; --card-bg: #fff; --text: #172b4d; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background: var(--bg); color: var(--text); padding: 20px; margin: 0; }
        
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 15px; }
        .header h1 { margin: 0; font-size: 1.5rem; display: flex; align-items: center; gap: 10px; color: #0052cc; }
        .header-controls { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
        .sync-icon { color: #aaa; font-size: 1.2rem; transition: color 0.3s; margin-right: 10px; }
        .sync-icon.loading { animation: spin 1s linear infinite; color: #0052cc; }
        .sync-icon.success { color: #36b37e; }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        .nav-container { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #dfe1e6; padding-bottom: 10px; margin-bottom: 20px; }
        .view-tabs { display: flex; gap: 10px; }
        .view-btn { border: none; background: none; font-size: 1.1rem; font-weight: bold; color: #6b778c; cursor: pointer; padding: 5px 15px; border-radius: 4px; transition: 0.2s; }
        .view-btn.active { color: #0052cc; background: #e3f2fd; }
        .filter-btn { display:none; background: #fff; border: 1px solid #dfe1e6; padding: 5px 15px; border-radius: 4px; cursor: pointer; color: #555; font-weight: bold; }
        .filter-btn:hover { background: #eee; color: #0052cc; }

        /* KANBAN */
        #kanbanView { display: flex; gap: 15px; overflow-x: auto; padding-bottom: 50px; min-height: 80vh; align-items: flex-start; scroll-behavior: smooth; -webkit-overflow-scrolling: touch; }
        .column { background: #ebecf0; border-radius: 10px; width: 320px; min-width: 320px; padding: 12px; display: flex; flex-direction: column; max-height: 85vh; border-top: 4px solid transparent; position: relative; }
        .column-header { font-weight: 700; margin-bottom: 15px; text-transform: uppercase; font-size: 0.85em; color: #42526e; display: flex; justify-content: space-between; align-items: center;}
        .col-menu-btn { cursor: pointer; padding: 5px; border-radius: 4px; } .col-menu-btn:hover { background: #dcdfe4; }
        .col-options { display: none; position: absolute; top: 40px; right: 10px; background: white; box-shadow: 0 5px 15px rgba(0,0,0,0.2); border-radius: 6px; z-index: 100; width: 150px; overflow: hidden;}
        .col-options div { padding: 10px; cursor: pointer; font-size: 0.9em; color: #333; } .col-options div:hover { background: #f4f5f7; color: #0052cc; } .col-options.active { display: block; }
        .card-list { flex-grow: 1; overflow-y: auto; min-height: 100px; padding-bottom: 10px;}
        .card { background: var(--card-bg); border-radius: 6px; padding: 12px; margin-bottom: 10px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); cursor: grab; position: relative; transition: transform 0.2s; border-left: 4px solid #ccc;}
        .card:hover { transform: translateY(-3px); box-shadow: 0 8px 16px rgba(0,0,0,0.1); }
        .card-title { font-weight: 700; font-size: 1rem; margin-bottom: 8px; color: #172b4d; display: flex; align-items: center; }
        .card-meta { font-size: 0.85em; color: #666; display: flex; align-items: center; gap: 6px; margin-top: 6px; }
        .card-actions { margin-top: 12px; border-top: 1px solid #f4f5f7; padding-top: 8px; display: flex; justify-content: flex-end; gap: 8px;}

        /* TIMELINE */
        #timelineView { display: none; max-width: 1000px; margin: 0 auto; }
        .timeline-item { background: white; padding: 15px; border-radius: 8px; margin-bottom: 10px; display: flex; align-items: center; justify-content: space-between; box-shadow: 0 2px 5px rgba(0,0,0,0.05); border-left: 5px solid transparent; }
        .tl-info { display: flex; flex-direction: column; gap: 5px; flex-grow: 1; }
        .tl-client { font-weight: bold; font-size: 1.1rem; color: #172b4d; display: flex; align-items: center; }
        .tl-product { color: #666; font-size: 0.9rem; }
        .tl-meta { display: flex; gap: 15px; align-items: center; margin-top: 5px; }
        .tl-date { font-weight: bold; font-size: 0.9rem; padding: 4px 8px; border-radius: 4px; background: #eee; }
        .tl-actions { display: flex; gap: 10px; align-items: center; }
        .status-select { padding: 8px; border-radius: 4px; border: 1px solid #dfe1e6; background: #f9f9f9; font-weight: bold; color: #444; max-width: 150px;}
        
        .status-dot { width: 12px; height: 12px; border-radius: 50%; display: inline-block; margin-right: 8px; border: 2px solid white; box-shadow: 0 0 3px rgba(0,0,0,0.2); }
        .dot-green { background: #36b37e; } .dot-yellow { background: #ffab00; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { opacity: 1; transform: scale(1); } 50% { opacity: 0.6; transform: scale(1.1); } 100% { opacity: 1; transform: scale(1); } }

        /* HEADER TABLE STYLE */
        .header-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        .header-row { display: flex; align-items: center; justify-content: space-between; background: #172b4d; padding: 8px 12px; margin-bottom: 5px; border-radius: 4px; color: #a5adba; font-family: monospace; font-size: 0.9em; }
        .header-key { font-weight: bold; color: #fff; width: 30%; }
        .header-val { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; width: 50%; color: #87ceeb; }
        .header-copy { width: 20%; text-align: right; }
        .copy-btn-sm { background: rgba(255,255,255,0.2); border: none; color: white; padding: 4px 8px; border-radius: 3px; cursor: pointer; font-size: 0.8em; }
        .copy-btn-sm:hover { background: rgba(255,255,255,0.4); }

        .btn-icon { background: #f4f5f7; border: none; cursor: pointer; color: #6b778c; border-radius: 4px; padding: 6px 10px; font-size: 0.8em; margin-left: 5px;}
        .btn-config { background: white; border: 1px solid #dfe1e6; padding: 10px; border-radius: 50%; cursor: pointer; font-size: 1.2rem; margin-left:5px;}
        .btn-add-new { background: #36b37e; color: white; border: none; padding: 10px 20px; border-radius: 6px; font-weight: bold; cursor: pointer; display: flex; align-items: center; gap: 8px; font-size: 0.9rem;}
        .btn-bot { background: #6554c0; color: white; border: none; padding: 10px 20px; border-radius: 6px; font-weight: bold; cursor: pointer; display: flex; align-items: center; gap: 8px; font-size: 0.9rem;}
        .btn-wa { background: #dcf8c6; color: #075e54; }
        .btn-wa:hover { background: #25d366; color: white; }
        
        .col-item { display: flex; align-items: center; gap: 10px; padding: 10px; background: #f9f9f9; margin-bottom: 8px; border-radius: 4px; border: 1px solid #eee; transition: background 0.2s;}
        .col-item.dragging { opacity: 0.5; background: #e3f2fd; border: 2px dashed #0052cc; }
        .col-inputs { flex-grow: 1; display: flex; gap: 5px; flex-direction: column; }
        .col-row { display: flex; gap: 5px; }
        .drag-handle { cursor: grab; color: #999; font-size: 1.2em; padding: 5px; }
        .drag-handle:active { cursor: grabbing; color: #0052cc; }
        
        .filter-item { display: flex; align-items: center; gap: 10px; padding: 10px; border-bottom: 1px solid #eee; }
        .filter-item input[type="checkbox"] { width: 20px; height: 20px; }

        @media (max-width: 768px) { body { padding: 10px; } .header-controls { width: 100%; justify-content: flex-end; } #kanbanView { gap: 10px; scroll-snap-type: x mandatory; padding-bottom: 20px; } .column { min-width: 85vw; width: 85vw; scroll-snap-align: center; } .timeline-item { flex-direction: column; align-items: flex-start; gap: 15px; } .tl-actions { width: 100%; justify-content: space-between; } .status-select { flex-grow: 1; } dialog { width: 95% !important; max-height: 90vh; margin: auto; } .btn-icon { padding: 10px; } }
        
        dialog { border: none; border-radius: 8px; box-shadow: 0 10px 40px rgba(0,0,0,0.3); padding: 0; width: 500px; font-family: inherit; overflow: hidden;} dialog::backdrop { background: rgba(0,0,0,0.6); } .modal-header { background: #f4f5f7; padding: 15px 20px; border-bottom: 1px solid #ddd; display: flex; justify-content: space-between; align-items: center;} .modal-body { padding: 20px; max-height: 500px; overflow-y: auto; } .tab-btn { background: none; border: none; padding: 10px; cursor: pointer; font-weight: bold; color: #666; border-bottom: 2px solid transparent; width: 48%;} .tab-btn.active { color: #0052cc; border-bottom-color: #0052cc; } .tab-content { display: none; } .tab-content.active { display: block; } .inp-full { width: 100%; padding: 10px; margin: 5px 0 15px 0; border: 1px solid #dfe1e6; border-radius: 4px; box-sizing: border-box; } .inp-mini { width: 70px; padding: 5px; border: 1px solid #ddd; border-radius: 4px; } .btn-primary { width: 100%; padding: 12px; background: #0052cc; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; margin-top: 10px;} .code-block { background: #172b4d; color: #a5adba; padding: 15px; border-radius: 6px; font-family: monospace; white-space: pre-wrap; margin-bottom: 10px; position: relative; word-break: break-all;} .btn-copy { position: absolute; top: 5px; right: 5px; background: rgba(255,255,255,0.2); border: none; color: white; padding: 4px 8px; border-radius: 3px; cursor: pointer; font-size: 0.8em; } label { font-size: 0.9em; font-weight: bold; color: #444; } #statusMsg { background: #0052cc; color:white; padding:5px 10px; border-radius:4px; display:none; }
    </style>
</head>
<body>
    <div class="header">
        <h1><i class="fa-solid fa-cloud sync-icon" id="syncIcon" title="Auto-Sync"></i> CRM Warrior</h1>
        <div class="header-controls">
            <div id="statusMsg"></div>
            <button class="btn-bot" onclick="openIntegrator()"><i class="fa-solid fa-robot"></i> <span style="display:none; @media(min-width:768px){display:inline;}">Integra√ß√£o</span></button>
            <button class="btn-add-new" onclick="openNewOrderModal()"><i class="fa-solid fa-plus"></i> <span style="display:none; @media(min-width:768px){display:inline;}">Novo</span></button>
            <button class="btn-config" onclick="openSettings()" title="Configura√ß√µes"><i class="fa-solid fa-gear"></i></button>
        </div>
    </div>

    <div class="nav-container">
        <div class="view-tabs">
            <button class="view-btn active" onclick="switchView('kanban')" id="btn-kanban"><i class="fa-solid fa-columns"></i> Kanban</button>
            <button class="view-btn" onclick="switchView('timeline')" id="btn-timeline"><i class="fa-solid fa-hourglass-half"></i> Prazos</button>
        </div>
        <button class="filter-btn" id="filterBtn" onclick="openFilterModal()"><i class="fa-solid fa-filter"></i> Filtrar Colunas</button>
    </div>

    <div id="kanbanView"></div>
    <div id="timelineView"></div>

    <dialog id="integratorModal">
        <div class="modal-header"><h3 style="margin:0">ü§ñ Webhook 2.0</h3><button onclick="closeModal('integratorModal')" style="border:none; background:none; cursor:pointer;">&times;</button></div>
        <div class="modal-body">
            <label style="color:#0052cc">Seu Token (GitHub):</label>
            <input type="text" id="integrationToken" class="inp-full" placeholder="Cole ghp_..." oninput="updateIntegratorCode()">
            <hr style="border:0; border-top:1px solid #eee; margin:20px 0;">
            
            <label>Tipo de A√ß√£o:</label>
            <select id="integrationActionType" class="inp-full" onchange="toggleIntegratorOptions()">
                <option value="move">üìÅ Mover Card de Coluna</option>
                <option value="color">üé® Alterar Cor (Sem√°foro)</option>
            </select>

            <div id="opt-move">
                <label>Mover para:</label><select id="integrationColSelect" class="inp-full" onchange="updateIntegratorCode()"></select>
            </div>
            
            <div id="opt-color" style="display:none;">
                <label>Definir Status:</label>
                <select id="integrationColorSelect" class="inp-full" onchange="updateIntegratorCode()">
                    <option value="true">üü° Aguardando Cliente</option>
                    <option value="false">üü¢ Em Execu√ß√£o</option>
                </select>
            </div>

            <h4 style="margin-bottom:5px; color:#333;">1. URL</h4>
            <div class="header-row">
                <span class="header-val" style="width:80%;" id="dispUrl">...</span>
                <span class="header-copy"><button class="copy-btn-sm" onclick="copyText('dispUrl')">Copiar</button></span>
            </div>

            <h4 style="margin-bottom:5px; color:#333;">2. Headers</h4>
            <div id="headersList"></div>

            <h4 style="margin-bottom:5px; color:#333;">3. Body (JSON)</h4>
            <div class="code-block" style="position:relative; font-size:0.85em;">
                <pre id="jsonContent" style="margin:0; white-space:pre-wrap;">...</pre>
                <button class="btn-copy" onclick="copyText('jsonContent')">Copiar</button>
            </div>
            
            <div id="codeUrl" style="display:none;"></div>
            <div id="codeBody" style="display:none;"></div>
        </div>
    </dialog>

    <dialog id="filterModal">
        <div class="modal-header"><h3 style="margin:0">üëÅÔ∏è Filtros</h3><button onclick="closeModal('filterModal')" style="border:none; background:none;">&times;</button></div>
        <div class="modal-body">
            <div id="filterList"></div>
            <hr style="border:0; border-top:1px solid #eee; margin:15px 0;">
            <div class="filter-item">
                <input type="checkbox" id="chk-hideWaiting">
                <span class="status-dot dot-yellow"></span>
                <label for="chk-hideWaiting">Ocultar "Aguardando Resposta"</label>
            </div>
            <button class="btn-primary" onclick="applyFilters()">Aplicar</button>
        </div>
    </dialog>

    <dialog id="settingsModal"><div class="modal-header"><h3 style="margin:0">Configura√ß√µes</h3><button onclick="closeModal('settingsModal')" style="border:none; background:none;">&times;</button></div><div class="modal-body"><div class="tab-content active"><div style="background:#e3f2fd;padding:10px;margin-bottom:10px;border-radius:4px;">‚úã Arraste para organizar.</div><div id="columnsList"></div><button class="btn-primary" onclick="saveAllColumns()">üíæ Salvar Ordem</button><h4 style="margin-top:20px;">Nova Coluna</h4><input id="newColTitle" class="inp-full" placeholder="Nome"><div style="display:flex;gap:10px;"><input type="color" id="newColColor" style="height:40px;width:50px;"><input type="number" id="newColDays" class="inp-full" placeholder="Dias"></div><button class="btn-primary" onclick="addColumn()">+ Adicionar</button></div></div></dialog>
    
    <dialog id="newOrderModal">
        <div class="modal-header"><h3 style="margin:0">Novo Pedido</h3><button onclick="closeModal('newOrderModal')" style="border:none; background:none;">&times;</button></div>
        <div class="modal-body">
            <label>Cliente *</label><input type="text" id="manualName" class="inp-full">
            <label>Telefone</label><input type="text" id="manualPhone" class="inp-full" placeholder="5542999...">
            <label>ID (Opcional)</label><input type="text" id="manualChatId" class="inp-full">
            <label>Coluna Inicial</label><select id="manualColumn" class="inp-full" onchange="autoDateManual(this.value)"></select>
            <label>Produto</label><input type="text" id="manualProduct" class="inp-full">
            <label>Prazo</label><input type="date" id="manualDate" class="inp-full">
            <button class="btn-primary" onclick="createManualOrder()">Criar</button>
        </div>
    </dialog>

    <dialog id="editOrderModal">
        <div class="modal-header"><h3 style="margin:0">Editar</h3><button onclick="closeModal('editOrderModal')" style="border:none; background:none;">&times;</button></div>
        <div class="modal-body">
            <input type="hidden" id="editOrderId">
            <label>Nome</label><input type="text" id="editClientName" class="inp-full">
            <label>Telefone</label><input type="text" id="editPhone" class="inp-full">
            <label>Produto</label><input type="text" id="editProduct" class="inp-full">
            <label>Prazo</label><input type="date" id="editDueDate" class="inp-full">
            <button class="btn-primary" onclick="saveOrderEdits()">Salvar</button>
        </div>
    </dialog>

    <script>
        const REPO_OWNER = 'thiagooler'; const REPO_NAME = 'CRM-NBV';
        let columnsConfig = {'todo': { title: 'üì• Novos', color: '#ff5630', days: 0 }, 'doing': { title: 'üî® Em Produ√ß√£o', color: '#ffab00', days: 30 }, 'done': { title: '‚úÖ Finalizado', color: '#42526e', days: 0 }};
        let columnOrder = ['todo', 'doing', 'done'];
        let orders = []; 
        let currentView = 'kanban'; 
        let visibleColumns = []; 
        let hideWaiting = false;
        let lastDataHash = ''; 
        let dragSrcEl = null;

        // FUN√á√ÉO GLOBAL FIXADA
        function switchView(view) {
            currentView = view;
            document.querySelectorAll('.view-btn').forEach(b => b.classList.remove('active'));
            const btn = document.getElementById('btn-'+view);
            if(btn) btn.classList.add('active');
            
            const kanbanDiv = document.getElementById('kanbanView');
            const timelineDiv = document.getElementById('timelineView');
            const filterBtn = document.getElementById('filterBtn');

            if(view === 'kanban') {
                kanbanDiv.style.display = 'flex';
                timelineDiv.style.display = 'none';
                filterBtn.style.display = 'none'; 
                renderBoard(); 
            } else {
                kanbanDiv.style.display = 'none';
                timelineDiv.style.display = 'block';
                filterBtn.style.display = 'block'; 
                renderTimeline();
            }
        }

        function getToken() { const p = new URLSearchParams(window.location.search); const t = p.get('token'); if(t) { localStorage.setItem('warrior_gh_token', t); return t; } return localStorage.getItem('warrior_gh_token'); }
        
        async function init() { 
            const t = getToken(); 
            const tkDisp = document.getElementById('tokenDisplay'); if(tkDisp) tkDisp.value = t ? t.substring(0,10) + '...' : 'N√£o configurado';
            if(!t) alert("Configure seu Token!"); 
            
            const savedFilters = localStorage.getItem('warrior_crm_filters'); if(savedFilters) visibleColumns = JSON.parse(savedFilters);
            const savedWaiting = localStorage.getItem('warrior_crm_hideWaiting'); if(savedWaiting) hideWaiting = JSON.parse(savedWaiting);
            
            await loadData();
            setInterval(() => loadData(true), 15000);
        }

        async function loadData(isAuto = false) { 
            const syncIcon = document.getElementById('syncIcon'); if(isAuto && syncIcon) syncIcon.classList.add('loading'); else showStatus('Carregando...', '#0052cc'); 
            try { 
                const r = await fetch(`db.json?t=${new Date().getTime()}`); 
                if(!r.ok) throw new Error("Erro DB"); 
                const d = await r.json(); 
                if (Array.isArray(d)) orders = d; else { orders = d.orders||[]; if(d.columns) columnsConfig = d.columns; if(d.columnOrder) columnOrder = d.columnOrder; else columnOrder = Object.keys(columnsConfig); } 
                
                const pending = JSON.parse(localStorage.getItem('warrior_pending') || '[]');
                const realPending = pending.filter(p => !orders.find(o => o.id === p.id));
                localStorage.setItem('warrior_pending', JSON.stringify(realPending));
                orders = [...orders, ...realPending];

                const currentHash = JSON.stringify({o: orders, c: columnsConfig});
                if (isAuto && currentHash === lastDataHash) { if(syncIcon) syncIcon.classList.remove('loading'); return; }
                lastDataHash = currentHash;

                if(visibleColumns.length === 0) visibleColumns = [...columnOrder];
                
                if(currentView === 'kanban') renderBoard(); else renderTimeline();
                if(isAuto) { if(syncIcon) { syncIcon.classList.remove('loading'); syncIcon.classList.add('success'); setTimeout(()=>syncIcon.classList.remove('success'),2000); } } else hideStatus();
            } catch (e) { if(!isAuto) hideStatus(); if(syncIcon) syncIcon.classList.remove('loading'); } 
        }

        function renderBoard() {
            const b = document.getElementById('kanbanView'); if(!b) return; b.innerHTML = ''; 
            columnOrder.forEach(k => { 
                const c = columnsConfig[k]; if(!c) return; 
                const d = document.createElement('div'); d.className = 'column'; d.style.borderTopColor = c.color; 
                d.innerHTML = `<div class="column-header" style="color:${c.color}"><span>${c.title} <span id="count-${k}" style="background:#fff;padding:2px 8px;border-radius:10px;font-size:0.8em;color:#333;">0</span></span><div style="position:relative"><i class="fa-solid fa-ellipsis-vertical col-menu-btn" onclick="toggleMenu('${k}')"></i><div id="menu-${k}" class="col-options"><div onclick="sortColumn('${k}','date')">üìÖ Prazo</div><div onclick="sortColumn('${k}','name')">üî§ Nome</div></div></div></div><div class="card-list" id="${k}" ondrop="drop(event)" ondragover="allowDrop(event)"></div>`; b.appendChild(d); 
                const l = d.querySelector('.card-list'); const o = orders.filter(ord => ord.status === k); 
                const cEl = document.getElementById(`count-${k}`); if(cEl) cEl.innerText = o.length; 
                o.forEach(or => l.appendChild(createCard(or, c.color))); 
            });
        }

        function renderTimeline() {
            const c = document.getElementById('timelineView'); if(!c) return; c.innerHTML = ''; 
            const s = [...orders].sort((a,b) => new Date(a.dueDate) - new Date(b.dueDate)); 
            s.forEach(o => { 
                if (!visibleColumns.includes(o.status)) return;
                if (hideWaiting && o.waiting) return;

                const col = columnsConfig[o.status]||{color:'#ccc',title:'?'}; const dt = new Date(o.dueDate); const df = Math.ceil((dt - new Date()) / (86400000)); let cl = '#36b37e'; if (df < 0) cl = '#bf2600'; else if (df <= 2) cl = '#ffab00'; if (o.status === 'done') cl = '#42526e'; let opts = ''; columnOrder.forEach(k => { if(columnsConfig[k]) opts += `<option value="${k}" ${o.status === k ? 'selected' : ''}>${columnsConfig[k].title}</option>`; }); const dotClass = o.waiting ? 'dot-yellow' : 'dot-green'; 
                
                // Bot√£o de Whats
                const whatsBtn = o.phone ? `<button class="btn-icon btn-wa" onclick="window.open('https://wa.me/${o.phone.replace(/[^0-9]/g,'')}', '_blank')"><i class="fa-brands fa-whatsapp"></i></button>` : '';

                c.innerHTML += `<div class="timeline-item" style="border-left-color:${col.color}"><div class="tl-info"><div class="tl-client"><span class="status-dot ${dotClass}"></span>${o.client}</div><div class="tl-product">${o.product}</div><div class="tl-meta"><span class="tl-date" style="color:${cl};border:1px solid ${cl}">${formatDate(o.dueDate)}</span><span style="font-size:0.8em;color:${col.color}"><i class="fa-solid fa-circle" style="font-size:0.6em"></i> ${col.title}</span></div></div><div class="tl-actions">${whatsBtn}<select class="status-select" onchange="changeStatus('${o.id}',this.value)">${opts}</select><button class="btn-icon" onclick="openEditOrder('${o.id}')"><i class="fa-solid fa-pen"></i></button></div></div>`; 
            }); 
        }

        function createCard(o, c) { 
            const d = document.createElement('div'); d.className = 'card'; d.id = o.id; d.draggable = true; d.style.borderLeftColor = c; d.ondragstart = drag; 
            const late = new Date(o.dueDate) < new Date() && o.status !== 'done'; const dotClass = o.waiting ? 'dot-yellow' : 'dot-green'; 
            
            // Bot√£o Whats
            const whatsBtn = o.phone ? `<button class="btn-icon btn-wa" title="Whats" onclick="window.open('https://wa.me/${o.phone.replace(/[^0-9]/g,'')}', '_blank')"><i class="fa-brands fa-whatsapp"></i></button>` : '';

            d.innerHTML = `<div class="card-title"><span class="status-dot ${dotClass}"></span> ${o.client}</div><div class="card-meta"><i class="fa-solid fa-box"></i> ${o.product}</div><div class="card-meta" style="${late?'color:red;font-weight:bold':''}"><i class="fa-regular fa-calendar"></i> ${formatDate(o.dueDate)}</div><div class="card-actions">${whatsBtn}<button class="btn-icon" onclick="copyLink('${o.id}')"><i class="fa-solid fa-link"></i></button><button class="btn-icon" onclick="openEditOrder('${o.id}')"><i class="fa-solid fa-pen"></i></button><button class="btn-icon btn-trash" onclick="deleteOrder('${o.id}')"><i class="fa-solid fa-trash"></i></button></div>`; return d; 
        }

        // --- MANIPULA√á√ÉO ---
        function openIntegrator() { 
            const t = localStorage.getItem('warrior_gh_token'); 
            const tkInput = document.getElementById('integrationToken');
            if(t && tkInput) tkInput.value = t; 
            const s = document.getElementById('integrationColSelect'); 
            if(s) { s.innerHTML = ''; columnOrder.forEach(k => { if(columnsConfig[k]) s.innerHTML += `<option value="${k}">${columnsConfig[k].title}</option>`; }); }
            toggleIntegratorOptions(); 
            const m = document.getElementById('integratorModal'); if(m) m.showModal(); 
        }

        function toggleIntegratorOptions() {
            const typeEl = document.getElementById('integrationActionType'); const type = typeEl ? typeEl.value : 'move';
            const divMove = document.getElementById('opt-move'); const divColor = document.getElementById('opt-color');
            if(divMove) divMove.style.display = type === 'move' ? 'block' : 'none';
            if(divColor) divColor.style.display = type === 'color' ? 'block' : 'none';
            updateIntegratorCode();
        }

        function updateIntegratorCode() {
            const tkEl = document.getElementById('integrationToken'); const token = tkEl ? tkEl.value.trim() : '';
            if(token) localStorage.setItem('warrior_gh_token', token); 
            const url = `https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/dispatches`;
            const dispUrl = document.getElementById('dispUrl'); if(dispUrl) dispUrl.innerText = url;
            const codeUrl = document.getElementById('codeUrl'); if(codeUrl) codeUrl.innerText = url;

            const headers = [{ k: 'Authorization', v: `token ${token || 'ghp_SEU_TOKEN'}` }, { k: 'Accept', v: 'application/vnd.github.v3+json' }, { k: 'Content-Type', v: 'application/json' }, { k: 'User-Agent', v: 'WarriorBot' }];
            const list = document.getElementById('headersList');
            if(list) { list.innerHTML = ''; headers.forEach(h => { const safeKey = h.k.replace(/-/g,''); list.innerHTML += `<div class="header-row"><span class="header-key">${h.k}</span><span class="header-val" id="val-${safeKey}">${h.v}</span><span class="header-copy"><button class="copy-btn-sm" onclick="copyText('val-${safeKey}')">Copiar</button></span></div>`; }); }

            const typeEl = document.getElementById('integrationActionType'); const type = typeEl ? typeEl.value : 'move';
            let json = {};
            if (type === 'move') {
                const colEl = document.getElementById('integrationColSelect'); const col = colEl ? colEl.value : '';
                json = { "event_type": "crm_event", "client_payload": { "real_action": "move_card_external", "chat_id": "{codigo-indicacao}", "telefone": "{telefone}", "status": col, "nome": "{nome-completo}" } };
            } else {
                const colSel = document.getElementById('integrationColorSelect'); const isWaiting = colSel ? (colSel.value === 'true') : false;
                json = { "event_type": "crm_event", "client_payload": { "real_action": "toggle_waiting", "chat_id": "{codigo-indicacao}", "waiting": isWaiting } };
            }
            const cb = document.getElementById('jsonContent'); if(cb) cb.innerText = JSON.stringify(json, null, 2);
            const hiddenBody = document.getElementById('codeBody'); if(hiddenBody) hiddenBody.innerText = JSON.stringify(json, null, 2);
        }

        // --- FILTROS ---
        function openFilterModal() { 
            const l = document.getElementById('filterList'); l.innerHTML = ''; 
            columnOrder.forEach(k => { 
                if(columnsConfig[k]) l.innerHTML += `<div class="filter-item"><input type="checkbox" id="chk-${k}" value="${k}" ${visibleColumns.includes(k)?'checked':''}><div style="width:15px;height:15px;background:${columnsConfig[k].color};border-radius:50%;"></div><label for="chk-${k}">${columnsConfig[k].title}</label></div>`; 
            }); 
            const waitChk = document.getElementById('chk-hideWaiting');
            if(waitChk) waitChk.checked = hideWaiting;
            document.getElementById('filterModal').showModal(); 
        }

        function applyFilters() { 
            visibleColumns = []; 
            document.querySelectorAll('#filterList input[type="checkbox"]').forEach(c => { if(c.checked) visibleColumns.push(c.value); }); 
            localStorage.setItem('warrior_crm_filters', JSON.stringify(visibleColumns)); 
            
            const waitChk = document.getElementById('chk-hideWaiting');
            if(waitChk) {
                hideWaiting = waitChk.checked;
                localStorage.setItem('warrior_crm_hideWaiting', JSON.stringify(hideWaiting));
            }

            closeModal('filterModal'); 
            renderTimeline(); 
        }

        async function sendToGitHub(realAction, payload) { const t = getToken(); if(!t) { alert("Token?"); return; } const body = { event_type: "crm_event", client_payload: { real_action: realAction, ...payload } }; try { const r = await fetch(`https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/dispatches`, { method: 'POST', headers: { 'Authorization': `token ${t}`, 'Accept': 'application/vnd.github.v3+json' }, body: JSON.stringify(body) }); if(!r.ok) throw new Error(r.status); } catch(e) { alert("Erro Envio: "+e.message); throw e; } }
        function copyText(id) { const el = document.getElementById(id); if(el) navigator.clipboard.writeText(el.innerText.replace('Copiar','').trim()).then(()=>alert("Copiado!")); } 
        function copyLink(id) { navigator.clipboard.writeText(window.location.href.replace('index.html','').split('?')[0] + 'rastreio/?id='+id); alert("Link Rastreio Copiado!"); }
        function closeModal(id) { document.getElementById(id).close(); } 
        function showStatus(m,c) { const e=document.getElementById('statusMsg'); if(e) { e.innerText=m; e.style.background=c; e.style.display='block'; } } 
        function hideStatus() { const e=document.getElementById('statusMsg'); if(e) e.style.display='none'; } 
        function formatDate(d) { return d ? d.split('-').reverse().join('/') : '--'; } 
        function sortColumn(k, t) { let c = orders.filter(o => o.status === k); let o = orders.filter(o => o.status !== k); if (t === 'date') c.sort((a,b) => new Date(a.dueDate) - new Date(b.dueDate)); else c.sort((a,b) => a.client.localeCompare(b.client)); orders = [...o, ...c]; renderBoard(); } 
        function allowDrop(ev) { ev.preventDefault(); } function drag(ev) { ev.dataTransfer.setData("text", ev.target.id); } 
        function toggleMenu(k) { document.getElementById('menu-'+k).classList.toggle('active'); } 
        function switchTab(id) { document.querySelectorAll('.tab-content').forEach(e => e.classList.remove('active')); document.querySelectorAll('.tab-btn').forEach(e => e.classList.remove('active')); document.getElementById(id).classList.add('active'); event.target.classList.add('active'); }
        function openNewOrderModal() { document.getElementById('manualName').value=''; document.getElementById('manualPhone').value=''; document.getElementById('manualChatId').value=''; document.getElementById('manualProduct').value=''; document.getElementById('manualDate').valueAsDate=new Date(); const s = document.getElementById('manualColumn'); s.innerHTML = ''; columnOrder.forEach(k => { if(columnsConfig[k]) s.innerHTML += `<option value="${k}">${columnsConfig[k].title}</option>`; }); document.getElementById('newOrderModal').showModal(); }
        function autoDateManual(s) { const d = columnsConfig[s]?.days || 0; if(d>0) { const dt = new Date(); dt.setDate(dt.getDate()+d); document.getElementById('manualDate').valueAsDate = dt; } }
        async function createManualOrder() { const n = document.getElementById('manualName').value; if(!n) return alert("Nome!"); const pay = { id: 'ped-' + Date.now(), nome: n, telefone: document.getElementById('manualPhone').value, chat_id: document.getElementById('manualChatId').value, produto: document.getElementById('manualProduct').value || 'Manual', prazo: document.getElementById('manualDate').value, status: document.getElementById('manualColumn').value, waiting: false }; const newOrder = { id: pay.id, client: pay.nome, phone: pay.telefone, chat_id: pay.chat_id, product: pay.produto, dueDate: pay.prazo, status: pay.status, waiting: false }; orders.push(newOrder); const pending = JSON.parse(localStorage.getItem('warrior_pending') || '[]'); pending.push(newOrder); localStorage.setItem('warrior_pending', JSON.stringify(pending)); closeModal('newOrderModal'); if(currentView==='kanban') renderBoard(); else renderTimeline(); showStatus('Enviando...', '#36b37e'); try { await sendToGitHub('novo_pedido', pay); showStatus('‚úÖ Enviado!', '#36b37e'); setTimeout(hideStatus, 2000); } catch(e) { showStatus('‚ùå Erro Envio!', '#bf2600'); } }
        function openEditOrder(id) { const o = orders.find(ord => ord.id === id); if(!o) return; document.getElementById('editOrderId').value = o.id; document.getElementById('editClientName').value = o.client; document.getElementById('editPhone').value = o.phone || ''; document.getElementById('editProduct').value = o.product; document.getElementById('editDueDate').value = o.dueDate; document.getElementById('editOrderModal').showModal(); }
        async function saveOrderEdits() { const id = document.getElementById('editOrderId').value; const c = document.getElementById('editClientName').value; const ph = document.getElementById('editPhone').value; const p = document.getElementById('editProduct').value; const d = document.getElementById('editDueDate').value; const idx = orders.findIndex(o => o.id === id); if(idx > -1) { orders[idx].client=c; orders[idx].phone=ph; orders[idx].product=p; orders[idx].dueDate=d; if(currentView==='kanban') renderBoard(); else renderTimeline(); } closeModal('editOrderModal'); try { await sendToGitHub('update_order', { id, client: c, phone: ph, product: p, dueDate: d }); } catch(e) {} }
        async function changeStatus(id, st) { const i = orders.findIndex(o => o.id === id); if(i === -1) return; const days = columnsConfig[st]?.days || 0; let nd = null; if(days>0) { const d = new Date(); d.setDate(d.getDate()+days); nd = d.toISOString().split('T')[0]; orders[i].dueDate = nd; } orders[i].status = st; if(currentView==='kanban') renderBoard(); else renderTimeline(); try { await sendToGitHub('update_status', { id, status: st, newDate: nd }); } catch(e) {} }
        async function drop(ev) { ev.preventDefault(); const id = ev.dataTransfer.getData("text"); const col = ev.target.closest('.card-list'); if (!col) return; const ns = col.id; if(orders.find(o=>o.id===id).status !== ns) changeStatus(id, ns); }
        async function saveAllColumns() { if(currentView === 'kanban') renderBoard(); showStatus('Salvando...', '#ffab00'); try { await sendToGitHub('save_columns', { columns: columnsConfig, order: columnOrder }); showStatus('‚úÖ Salvo!', '#36b37e'); setTimeout(hideStatus, 2000); } catch(e) { showStatus('‚ùå Erro!', '#bf2600'); } }
        async function addColumn() { const t = document.getElementById('newColTitle').value; if(!t) return; const id = t.toLowerCase().replace(/[^a-z0-9]/g, '')+'_'+Math.floor(Math.random()*1000); columnsConfig[id] = { title: t, color: document.getElementById('newColColor').value, days: parseInt(document.getElementById('newColDays').value)||0 }; columnOrder.push(id); document.getElementById('newColTitle').value = ''; openSettings(); }
        async function removeColumn(k) { if(!confirm("Remover?")) return; delete columnsConfig[k]; columnOrder = columnOrder.filter(id => id !== k); openSettings(); }
        async function deleteOrder(id) { if(confirm('Apagar?')) { orders = orders.filter(o => o.id !== id); if(currentView==='kanban') renderBoard(); else renderTimeline(); try { await sendToGitHub('delete_order', { id }); } catch(e) {} } }
        function openSettings() { const l = document.getElementById('columnsList'); l.innerHTML = ''; columnOrder.forEach(k => { if(columnsConfig[k]) { const c = columnsConfig[k]; const d = document.createElement('div'); d.className='col-item'; d.draggable=true; d.dataset.key=k; d.innerHTML = `<div class="drag-handle"><i class="fa-solid fa-grip-lines"></i></div><div class="color-dot" style="background:${c.color}"></div><div class="col-inputs"><input class="inp-full" style="margin:0;padding:5px;" value="${c.title}" onchange="columnsConfig['${k}'].title=this.value"><div class="col-row"><input type="number" class="inp-mini" value="${c.days}" onchange="columnsConfig['${k}'].days=parseInt(this.value)"><input type="color" style="height:30px;" value="${c.color}" onchange="columnsConfig['${k}'].color=this.value"></div></div><button onclick="removeColumn('${k}')" style="color:red;border:none;background:none;"><i class="fa-solid fa-trash"></i></button>`; d.addEventListener('dragstart', handleDragStart); d.addEventListener('dragover', handleDragOver); d.addEventListener('drop', handleDrop); l.appendChild(d); } }); document.getElementById('settingsModal').showModal(); }
        function handleDragStart(e) { dragSrcEl = this; e.dataTransfer.effectAllowed = 'move'; } function handleDragOver(e) { e.preventDefault(); return false; } function handleDrop(e) { e.stopPropagation(); if (dragSrcEl !== this) { const s = dragSrcEl.dataset.key; const t = this.dataset.key; const si = columnOrder.indexOf(s); const ti = columnOrder.indexOf(t); if(si>-1 && ti>-1) { columnOrder.splice(si, 1); columnOrder.splice(ti, 0, s); openSettings(); } } return false; }

        document.addEventListener('click', e => { if(!e.target.closest('.col-menu-btn')) document.querySelectorAll('.col-options').forEach(el=>el.classList.remove('active')); });
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
